---
description: Test Coverage Requirements
alwaysApply: false
---
# Test Coverage Requirements

This rule defines which files require tests and the expected test file naming conventions and directory structure.

## Files That Require Tests

The following file types MUST have corresponding test files:

### 1. Actions (`**/core/actions/**/*`)
- Actions represent individual use cases and MUST be tested
- Test files should mirror the source directory structure

### 2. Operations (`**/http/operations/**/*`, `**/web/operations/**/*`, or `**/operations/**/*`)
- HTTP operations and API endpoints MUST be tested
- Test files should mirror the source directory structure
- For Python projects, operations are typically in `web/operations/` (FastAPI)

### 3. Infrastructure (`**/core/infrastructure/**/*`)
- Infrastructure implementations MUST be tested
- This includes:
  - Repository implementations (e.g., `postgres/`, `in_memory/`)
  - Other infrastructure concerns (e.g., external API clients, message queues)

## Files That Do NOT Require Tests

The following files are exempt from test coverage requirements:

### 1. Domain Files (`**/core/domain/**/*`)
- Domain entities, value objects, and domain logic are tested through integration tests in actions/operations
- Domain layer does NOT require unit tests

### 2. Test Files Themselves
- Files containing `.test.` or `.spec.` in their path
- Files in test directories (e.g., `core_test/`, `core_spec/`, `http_test/`, `web_spec/`)

## Test File Naming Conventions

Test files MUST follow one of these naming patterns:
- `.test.{ext}` (e.g., `AddCodebase.test.ts`, `GetItems.test.py`)
- `.spec.{ext}` (e.g., `AddCodebase.spec.ts`, `GetItems.spec.py`)

Both patterns are acceptable. The test file extension MUST match the source file extension (e.g., `.ts` → `.test.ts`, `.py` → `.test.py`).

### Python-Specific Naming Requirements

For Python test files, pytest requires test files to start with `test_` prefix. Therefore, Python test files MUST use one of these patterns:
- `test_{name}.py` (e.g., `test_get_items.py`, `test_add_codebase.py`)
- `test_{name}.test.py` (e.g., `test_get_items.test.py`) - less common but acceptable

**Important**: The basename (without extension) of test files MUST be unique across ALL test directories to avoid Python import conflicts. If an action test and operation test would have the same basename, use a suffix to distinguish them (e.g., `test_get_validation_job_status.py` for action, `test_get_validation_job_status_operation.py` for operation).

## Test Directory Structure

### Actions and Infrastructure Tests
Test files should mirror the source directory structure in dedicated test directories:

**Source:** `core/actions/codebase/AddCodebase.{ts,py}`
**Tests (one of):**
- `core_test/actions/codebase/AddCodebase.test.{ts,py}`
- `core_test/actions/codebase/AddCodebase.spec.{ts,py}`
- `core_spec/actions/codebase/AddCodebase.test.{ts,py}`
- `core_spec/actions/codebase/AddCodebase.spec.{ts,py}`

### Operations Tests
Test files should mirror the source directory structure:

**Source:** `http/operations/codebase/AddCodebaseOperation.{ts,py}`
**Source:** `web/operations/codebase/add_codebase_operation.{ts,py}`
**Tests (one of):**
- `http_test/operations/codebase/AddCodebaseOperation.test.{ts,py}`
- `http_test/operations/codebase/AddCodebaseOperation.spec.{ts,py}`
- `web_test/operations/codebase/add_codebase_operation.test.{ts,py}` (for Python projects using `web/operations/`)
- `web_test/operations/codebase/add_codebase_operation.spec.{ts,py}`

**Note**: For Python projects, use `web_test` if operations are in `web/operations/`, or `http_test` if operations are in `http/operations/`.

### Repository Implementation Tests
Repository implementations (e.g., `InMemory*`, `Postgres*`) MUST be tested by a single consolidated test file that tests the interface, not individual implementations:

**Source:** `core/infrastructure/in_memory/InMemoryCodebases.{ts,py}`
**Source:** `core/infrastructure/postgres/PostgresCodebases.{ts,py}`
**Tests (one of):**
- `core_test/infrastructure/repositories/Codebases.test.{ts,py}`
- `core_test/infrastructure/repositories/Codebases.spec.{ts,py}`
- `core_spec/infrastructure/repositories/Codebases.test.{ts,py}`
- `core_spec/infrastructure/repositories/Codebases.spec.{ts,py}`

**Important:** 
- Remove implementation-specific prefixes (e.g., `InMemory`, `Postgres`) from the test file name
- Test the repository interface behavior, not implementation details
- Both implementations are tested by the same test file

## Examples

### TypeScript Examples

**Action requiring test:**
- Source: `core/actions/codebase/AddCodebase.ts`
- Expected test: `core_test/actions/codebase/AddCodebase.test.ts` (or `.spec.ts`)

**Operation requiring test:**
- Source: `http/operations/codebase/AddCodebaseOperation.ts`
- Expected test: `http_test/operations/codebase/AddCodebaseOperation.test.ts` (or `.spec.ts`)

**Repository requiring test:**
- Source: `core/infrastructure/postgres/PostgresUsers.ts`
- Expected test: `core_test/infrastructure/repositories/Users.test.ts` (or `.spec.ts`)

**Domain file (no test required):**
- Source: `core/domain/user/User.ts`
- No test file required

### Python Examples

**Action requiring test:**
- Source: `core/actions/codebase/add_codebase.py`
- Expected test: `core_test/actions/codebase/test_add_codebase.py` (Python: must start with `test_`)

**Operation requiring test:**
- Source: `web/operations/codebase/add_codebase_operation.py`
- Expected test: `web_test/operations/codebase/test_add_codebase_operation.py` (Python: must start with `test_`)
- Alternative: `web_test/operations/codebase/test_add_codebase_operation_operation.py` (if naming conflict with action test)

**Repository requiring test:**
- Source: `core/infrastructure/postgres/postgres_users.py`
- Expected test: `core_test/infrastructure/repositories/test_users.py` (Python: must start with `test_`)

**Domain file (no test required):**
- Source: `core/domain/user/user.py`
- No test file required

## Enforcement

When creating or modifying files in the following directories, ensure corresponding test files exist:
- `**/core/actions/**/*`
- `**/http/operations/**/*` or `**/operations/**/*`
- `**/core/infrastructure/**/*`

When creating or modifying domain files, do NOT create unit tests for them. Test domain logic through integration tests in actions/operations instead.

## Python-Specific Testing Considerations

### FastAPI Operations Testing

When testing FastAPI operations/endpoints:
- Use `fastapi.testclient.TestClient` to test HTTP endpoints
- Ensure `httpx` dependency is installed (required by TestClient)
- Mock the `provider` dictionary to isolate operation logic from action implementations
- Test both success and error cases, including HTTP validation errors

### Avoiding Import Conflicts

When creating Python test files:
- Ensure test file basenames are unique across ALL test directories (`core_test`, `web_test`, etc.)
- If an action and operation have similar names, use suffixes to distinguish test files:
  - Action test: `test_get_validation_job_status.py`
  - Operation test: `test_get_validation_job_status_operation.py`
- Clear `__pycache__` directories if import conflicts occur: `find . -name "__pycache__" -type d -exec rm -r {} +`

### Test Directory Structure for Python

For Python projects, test directories typically use:
- `core_test/` for core layer tests (actions, infrastructure)
- `web_test/` or `http_test/` for HTTP/operations layer tests

Ensure `conftest.py` exists in test directories to set up Python path and shared fixtures.
